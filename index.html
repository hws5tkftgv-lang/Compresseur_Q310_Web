<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Compresseur Quincy 310L - Schéma interactif</title>

  <style>
    body{margin:0;background:#0c132e;color:#dfe7ff;font-family:Arial,Helvetica,sans-serif;}
    .toolbar{display:flex;flex-wrap:wrap;gap:6px;padding:10px;background:#101b42;border-bottom:1px solid #000;}
    button{padding:6px 10px;border:1px solid #4b5f9f;border-radius:8px;background:#1b2a55;color:#eaf1ff;cursor:pointer;}
    button.active{background:#0067ff;font-weight:bold;box-shadow:0 0 6px #0090ff;}
    button:hover{filter:brightness(1.2);}
    #zoom{vertical-align:middle;}
    .panel{padding:12px;background:#14204f;border-left:2px solid #243463;}
    .row{margin-bottom:10px;}
    label{font-size:.85rem;}
    select,input,textarea{width:100%;background:#0c173c;border:1px solid #415a9f;color:#fff;border-radius:6px;padding:6px;}
    textarea{min-height:120px;}
    .wrap{display:grid;grid-template-columns:1fr 340px;height:calc(100vh - 55px);}
    canvas{touch-action:none;user-select:none;}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>
</head>
<body>

<div class="toolbar">
  <button id="btn-move">🧿 Déplacer</button>
  <button id="btn-draw">✏️ Dessiner</button>
  <button id="btn-pan">✋ Pan</button>
  <button id="btn-select">🖱️ Sélection</button>
  <button id="btn-delete">❌ Supprimer</button>
  <button id="btn-clear">🗑️ Effacer tout</button>

  <span style="margin-left:auto;"></span>

  <label>Zoom <input type="range" id="zoom" min="25" max="300" value="100"></label>
  <button id="btn-export">💾 Export</button>
  <label>📥 Import<input id="fileImport" type="file" style="display:none"></label>
</div>

<div class="wrap">
  <canvas id="c"></canvas>

  <div class="panel">
    <div class="row">
      <label>Pièce :</label>
      <select id="inventorySelect"></select>
    </div>
    <div class="row">
      <label>Titre :</label>
      <input id="partTitle" />
    </div>
    <div class="row">
      <label>Description :</label>
      <textarea id="partDescription"></textarea>
    </div>
    <button id="btn-apply">✅ Appliquer</button>
    <button id="btn-show-all">👁️ Afficher tout</button>
  </div>
</div>

<script>
/******** INVENTAIRE INTÉGRÉ ********/
const INVENTAIRE = [
  {"id":1,"code":"FIL-ENT","nom":"Filtre d’admission","desc":"Retient poussières/particules pour protéger les soupapes et le cylindre."},
  {"id":2,"code":"SOUP-ADM","nom":"Soupape d’admission","desc":"Laisse entrer l’air dans le cylindre pendant l’admission."},
  {"id":3,"code":"SOUP-ECH","nom":"Soupape d’échappement","desc":"Permet à l’air comprimé de sortir vers l’intercooler ou le réservoir."},
  {"id":4,"code":"CYL-LP","nom":"Cylindre basse pression","desc":"Première compression, grand diamètre."},
  {"id":5,"code":"CYL-HP","nom":"Cylindre haute pression","desc":"Deuxième compression, petit diamètre pour monter plus haut en pression."}
];

/******** CANVAS ********/
const canvas = new fabric.Canvas("c",{selection:false});
let bgImg=null,isDraw=false,isMove=true,isPan=false,isSelect=false;
let drawing=null,start=null;let FIT="contain";

function resize(){canvas.setWidth(window.innerWidth-360);canvas.setHeight(window.innerHeight-55);}
resize();window.addEventListener("resize",()=>{resize();fitBG(bgImg);});

/******** LOAD IMAGE ********/
function fitBG(img){if(!img)return;
 let cw=canvas.getWidth(),ch=canvas.getHeight(),iw=img.width,ih=img.height;
 let s=(FIT==="contain"?Math.min(cw/iw,ch/ih):Math.max(cw/iw,ch/ih));
 img.scale(s);img.left=(cw-iw*s)/2;img.top=(ch-ih*s)/2;canvas.sendToBack(img);}
fabric.Image.fromURL("actif/compresseur_bg.png",i=>{bgImg=i;bgImg.selectable=false;canvas.add(i);fitBG(i);loadSaved();});

/******** ZONES ********/
function toNorm(o){
 let r=o.getBoundingRect();let w=bgImg.getScaledWidth(),h=bgImg.getScaledHeight();
 let bx=bgImg.left,by=bgImg.top;
 return {id:o.pieceId||'',x:(r.left-bx)/w,y:(r.top-by)/h,w:r.width/w,h:r.height/h};
}
function fromNorm(z){
 let w=bgImg.getScaledWidth(),h=bgImg.getScaledHeight();let bx=bgImg.left,by=bgImg.top;
 let o=new fabric.Rect({left:bx+z.x*w,top:by+z.y*h,width:z.w*w,height:z.h*h,
 fill:"rgba(0,255,0,.15)",stroke:"#0f0",strokeWidth:2,rx:6,ry:6});
 o.pieceId=z.id;canvas.add(o);return o;}
function fillPanel(o){
 let p=INVENTAIRE.find(x=>String(x.id)==String(o.pieceId));
 document.getElementById("inventorySelect").value=o.pieceId||"";
 document.getElementById("partTitle").value=p?.nom||"";
 document.getElementById("partDescription").value=p?.desc||"";}

/******** SAVE ********/
function save(){let z=canvas.getObjects().filter(x=>x!==bgImg).map(toNorm);
 localStorage.setItem("zones",JSON.stringify(z));}
function loadSaved(){
 let d=localStorage.getItem("zones");if(!d)return;
 JSON.parse(d).forEach(z=>fromNorm(z));canvas.requestRenderAll();}

/******** TOOLS ********/
canvas.on("mouse:down",e=>{
 if(isPan){canvas.isDragging=true;canvas.lastX=e.e.clientX;canvas.lastY=e.e.clientY;return;}
 if(!isDraw)return;start=canvas.getPointer(e.e);
 drawing=new fabric.Rect({left:start.x,top:start.y,width:1,height:1,fill:"rgba(0,255,0,.15)",stroke:"#0f0"});
 canvas.add(drawing);
});
canvas.on("mouse:move",e=>{
 if(canvas.isDragging&&isPan){let dx=e.e.clientX-canvas.lastX,dy=e.e.clientY-canvas.lastY;
 canvas.relativePan(new fabric.Point(dx,dy));canvas.lastX=e.e.clientX;canvas.lastY=e.e.clientY;return;}
 if(!isDraw||!drawing)return;
 let p=canvas.getPointer(e.e);
 drawing.set({left:Math.min(p.x,start.x),top:Math.min(p.y,start.y),
 width:Math.abs(p.x-start.x),height:Math.abs(p.y-start.y)});canvas.renderAll();});
canvas.on("mouse:up",e=>{
 if(canvas.isDragging){canvas.isDragging=false;return;}
 if(!isDraw||!drawing)return;
 drawing.selectable=true;drawing=null;save();});

/******** CLICK SELECT MODE ********/
canvas.on("mouse:up",e=>{
 if(!isSelect)return;let o=e.target;if(!o||o===bgImg)return;
 canvas.getObjects().forEach(x=>{if(x!==bgImg)x.opacity=(x===o?1:.15);});
 fillPanel(o);canvas.renderAll();});

/******** UI ********/
function mode(m){
 isDraw=m=="draw";isMove=m=="move";isPan=m=="pan";isSelect=m=="select";
 document.querySelectorAll("button").forEach(b=>b.classList.remove("active"));
 document.getElementById("btn-"+m).classList.add("active");
 canvas.getObjects().forEach(o=>{o.selectable=isMove&&(o!==bgImg);});
}
mode("move");

document.getElementById("btn-move").onclick=()=>mode("move");
document.getElementById("btn-draw").onclick=()=>mode("draw");
document.getElementById("btn-pan").onclick=()=>mode("pan");
document.getElementById("btn-select").onclick=()=>mode("select");
document.getElementById("btn-delete").onclick=()=>{let o=canvas.getActiveObject();if(o&&o!==bgImg){canvas.remove(o);save();}};

document.getElementById("btn-clear").onclick=()=>{if(confirm("Effacer toutes les zones ?")){
 canvas.getObjects().forEach(o=>{if(o!==bgImg)canvas.remove(o)});save();canvas.renderAll();}};

document.getElementById("btn-show-all").onclick=()=>{canvas.getObjects().forEach(o=>o.opacity=1);canvas.renderAll();};

document.getElementById("zoom").oninput=e=>{
 let z=e.target.value/100;canvas.setZoom(z);};

document.getElementById("btn-export").onclick=()=>{
 let blob=new Blob([localStorage.getItem("zones")],{type:"application/json"});
 let a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="zones.json";a.click();};

document.getElementById("inventorySelect").onchange=e=>{
 let p=INVENTAIRE.find(x=>String(x.id)==e.target.value);
 document.getElementById("partTitle").value=p?.nom||"";
 document.getElementById("partDescription").value=p?.desc||"";};

document.getElementById("btn-apply").onclick=()=>{
 let o=canvas.getActiveObject();if(!o||o===bgImg)return;
 o.pieceId=document.getElementById("inventorySelect").value;save();};

/******** INVENTORY LOAD ********/
document.getElementById("inventorySelect").innerHTML=
 "<option value=''>-- Pièce --</option>"+
 INVENTAIRE.map(p=>`<option value="${p.id}">${p.code+" - "+p.nom}</option>`).join("");

</script>

</body>
</html>





