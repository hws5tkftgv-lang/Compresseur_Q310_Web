<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quincy 310L ‚Äì Sch√©ma interactif (Nom + R√¥le + Description)</title>

  <!-- FabricJS -->
  <script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>

  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    body { margin: 0; background:#0c132e; color:#eaf1ff; font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif; }
    .toolbar { display:flex; flex-wrap:wrap; gap:.5rem; align-items:center; padding:10px 12px; background:#0f1a3f; border-bottom:1px solid rgba(255,255,255,.08); }
    .btn { padding:7px 11px; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:#1a2553; color:#eaf1ff; cursor:pointer; }
    .btn:hover { filter:brightness(1.12); }
    .btn.active { background:#0078ff; color:#fff; font-weight:700; border-color:#0053ad; box-shadow:0 0 8px rgba(0,120,255,.65); }
    .chip { padding:6px 10px; border-radius:10px; background:#192247; border:1px solid rgba(255,255,255,.12); }
    .wrap { display:grid; grid-template-columns: 1fr 370px; gap:12px; padding:12px; }
    @media (max-width: 1100px) { .wrap { grid-template-columns: 1fr; } }
    .stage { background:#0b1536; border:1px solid rgba(255,255,255,.08); border-radius:12px; overflow:hidden; min-height:60vh; }
    canvas { touch-action:none; user-select:none; }
    .panel { background:#0f1a44; border:1px solid rgba(255,255,255,.10); border-radius:12px; padding:12px; }
    .panel h3 { margin:6px 0 10px; }
    .row { display:flex; flex-direction:column; gap:6px; margin-bottom:10px; }
    label { font-size:.92rem; opacity:.92; }
    select, input[type="text"], textarea { width:100%; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.18); background:#0b1638; color:#eaf1ff; }
    textarea { min-height:120px; resize:vertical; }
    .small { font-size:.85rem; opacity:.75; }
  </style>
</head>
<body>

  <!-- Barre d‚Äôoutils -->
  <div class="toolbar">
    <button id="btn-move" class="btn">üßø D√©placer/Redim.</button>
    <button id="btn-draw" class="btn">‚úèÔ∏è Dessiner</button>
    <button id="btn-pan" class="btn">‚úã Pan</button>
    <button id="btn-select" class="btn">üñ±Ô∏è S√©lection</button>
    <button id="btn-delete" class="btn">‚ùå Supprimer</button>
    <button id="btn-clear" class="btn">üóëÔ∏è Effacer tout</button>

    <span style="flex:1 1 auto;"></span>

    <span class="chip">Zoom <input id="zoom" type="range" min="25" max="300" step="1" value="100"></span>
    <span id="toggle-fit" class="btn chip">Mode: <strong>Tout voir</strong></span>
    <button id="btn-fit" class="btn">üñºÔ∏è Ajuster</button>
    <button id="btn-export" class="btn">üíæ Export JSON</button>
    <label class="btn">üì• Import JSON <input id="fileImport" type="file" accept=".json,application/json" style="display:none"></label>
  </div>

  <!-- Sc√®ne + Panneau -->
  <div class="wrap">
    <div class="stage"><canvas id="c"></canvas></div>

    <aside class="panel">
      <h3>üìò Fiche zone (Nom + R√¥le + Description)</h3>
      <p class="small">Mode <b>S√©lection</b> : clique une zone pour afficher sa fiche.<br>
      Pour associer une pi√®ce √† une zone, choisis dans la liste puis ‚ÄúAppliquer‚Äù.</p>

      <div class="row">
        <label for="inventorySelect">Pi√®ce (identifiant technique ‚Äì conseill√©)</label>
        <select id="inventorySelect"></select>
      </div>

      <div class="row">
        <label for="partName">Nom</label>
        <input id="partName" type="text" readonly />
      </div>

      <div class="row">
        <label for="partRole">R√¥le</label>
        <input id="partRole" type="text" readonly />
      </div>

      <div class="row">
        <label for="partDesc">Description</label>
        <textarea id="partDesc" readonly></textarea>
      </div>

      <div class="row" style="display:flex; gap:8px;">
        <button id="btn-apply" class="btn" style="flex:1;">‚úÖ Appliquer √† la zone</button>
        <button id="btn-show-all" class="btn" style="flex:1;">üëÅÔ∏è Afficher toutes les zones</button>
      </div>

      <p class="small">üíæ Sauvegarde automatique locale (navigateur). Export/Import pour partager.</p>
    </aside>
  </div>

  <script>
    /***********************
     * INVENTAIRE INT√âGR√â  *
     * (Nom + R√¥le + Description)
     ***********************/
    const INVENTAIRE = [
      {"id":"filtre_air","nom":"Filtre √† air capot√©","role":"Filtrer l‚Äôair d‚Äôadmission","description":"R√©duit les poussi√®res √† l‚Äôentr√©e, prot√®ge les soupapes et cylindres."},
      {"id":"element_filtre_air","nom":"√âl√©ment de filtre d‚Äôair","role":"Remplacement p√©riodique","description":"Cartouche interne du filtre √† air; essentielle pour la VE."},
      {"id":"silencieux_admission","nom":"Silencieux d‚Äôadmission","role":"Att√©nuer le bruit d‚Äôentr√©e","description":"Version capot√©e/hooded; se monte c√¥t√© aspiration."},
      {"id":"cylindre_lp","nom":"Cylindre basse pression (LP)","role":"Chambre compression 1√®re √©tape","description":"Re√ßoit l‚Äôair ambiant via soupapes d‚Äôadmission LP."},
      {"id":"cylindre_hp","nom":"Cylindre haute pression (HP)","role":"Chambre compression 2e √©tape","description":"Re√ßoit l‚Äôair refroidi de l‚Äôintercooler."},
      {"id":"piston_lp","nom":"Piston LP","role":"Compression 1√®re √©tape","description":"Al√©sage typique ~3,5\", segments adapt√©s au LP."},
      {"id":"piston_hp","nom":"Piston HP","role":"Compression 2e √©tape","description":"Al√©sage typique ~2,5\", travaille √† pression plus √©lev√©e."},
      {"id":"segments_lp","nom":"Segments de piston LP","role":"√âtanch√©it√© piston/cylindre","description":"Jeux/positionnement √† respecter pour bonne VE."},
      {"id":"segments_hp","nom":"Segments de piston HP","role":"√âtanch√©it√© piston/cylindre","description":"Mat√©riaux adapt√©s √† T¬∞/P plus √©lev√©es."},
      {"id":"axe_piston","nom":"Axis de piston","role":"Articulation piston‚Äìbielle","description":"Montage serr√© contr√¥l√©; lubrification par barbotage/pression."},
      {"id":"bielle_lp","nom":"Bielle LP","role":"Transmission mouvement","description":"Pied sur axe piston; t√™te sur maneton vilebrequin."},
      {"id":"bielle_hp","nom":"Bielle HP","role":"Transmission mouvement","description":"Analogues LP mais cotes diff√©rentes."},
      {"id":"coussinets_bielle","nom":"Coussinets de bielle","role":"Palier lisse t√™te de bielle","description":"Film d‚Äôhuile; contr√¥le jeu radial."},
      {"id":"vilebrequin","nom":"Vilebrequin","role":"Convertir rotation en translation","description":"Manetons, per√ßages huile, √©quilibrage."},
      {"id":"paliers_vilbrequin","nom":"Paliers principaux","role":"Support vilebrequin","description":"Roulements/bronzes selon version; lub. forc√©e."},
      {"id":"carter","nom":"Carter (crankcase)","role":"Structure et r√©servoir d‚Äôhuile","description":"Loge paliers, pompe √† huile, circuits d‚Äôhuile."},
      {"id":"porte_palier","nom":"Porte-palier (bearing carrier)","role":"Support palier + pompe","description":"Int√®gre filtration d‚Äôhuile selon r√©vision."},
      {"id":"pompe_huile","nom":"Pompe √† huile","role":"Distribution d‚Äôhuile sous pression","description":"Alimente vilebrequin, bielles, t√™tes."},
      {"id":"filtre_huile","nom":"Filtre √† huile","role":"Filtration lubrifiant","description":"Retient particules; entretien r√©gulier."},
      {"id":"crepine_huile","nom":"Cr√©pine d‚Äôaspiration","role":"Protection pompe √† huile","description":"Maille avant pompe; √©vite gros d√©bris."},
      {"id":"jauge_huile","nom":"Jauge/dipstick","role":"Contr√¥le niveau d‚Äôhuile","description":"Lecture niveau mini/maxi."},
      {"id":"bouchon_remplissage","nom":"Bouchon de remplissage d‚Äôhuile","role":"Remplir le carter","description":"Avec √©vent/reniflard selon versions."},
      {"id":"reniflard","nom":"Breather/reniflard","role":"√âvacuation vapeurs carter","description":"Limite surpressions internes carter."},
      {"id":"joint_carter","nom":"Joint de carter","role":"√âtanch√©it√© carter","description":"Joint papier/fibre; se remplace √† chaque d√©pose."},
      {"id":"joint_couvre_carter","nom":"Joint couvercle carter","role":"√âtanch√©it√© couvercle","description":"Emp√™che fuite huile/air."},
      {"id":"soupape_admission_lp","nom":"Soupape d‚Äôadmission LP","role":"Admettre l‚Äôair cylindre LP","description":"Actionn√©e par diff. de pression."},
      {"id":"soupape_decharge_lp","nom":"Soupape de d√©charge LP","role":"√âvacuer air comprim√© LP","description":"Vers l‚Äôintercooler; clapet anti-retour local."},
      {"id":"soupape_admission_hp","nom":"Soupape d‚Äôadmission HP","role":"Admettre l‚Äôair cylindre HP","description":"Depuis l‚Äôintercooler (refroidi)."},
      {"id":"soupape_decharge_hp","nom":"Soupape de d√©charge HP","role":"√âvacuer air vers refoulement","description":"Vers ligne de refoulement/r√©servoir."},
      {"id":"plaque_valves","nom":"Platine/si√®ge de soupapes","role":"Support/distribution soupapes","description":"Plateaux/si√®ges et visserie associ√©e."},
      {"id":"ressorts_soupapes","nom":"Ressorts de soupapes","role":"Rappel fermeture","description":"Caract√©ristiques LP/HP selon √©tage."},
      {"id":"intercooler","nom":"Intercooler","role":"Refroidir air entre LP et HP","description":"R√©duit T¬∞, travail HP et humidit√©."},
      {"id":"tubulure_intercooler","nom":"Tubulure d‚Äôintercooler","role":"Liaison LP‚Üíintercooler‚ÜíHP","description":"Tuyauteries + raccords/olive."},
      {"id":"clapet_antiretour","nom":"Clapet anti-retour","role":"Emp√™cher retour d‚Äôair","description":"S√©curit√© refoulement; prot√®ge soupapes."},
      {"id":"dechargeur_admission","nom":"D√©chargeur d‚Äôadmission","role":"D√©marrage √† vide/contr√¥le charge","description":"Pilote l‚Äôouverture admission pour no-load."},
      {"id":"pilot_valve","nom":"Valve pilote","role":"Commander d√©chargeurs par pression","description":"R√©glage consigne/diff√©rentiel."},
      {"id":"ligne_pilotage","nom":"Ligne de pilotage","role":"Transmettre pression de commande","description":"Capillaire/rigide selon montage."},
      {"id":"soupape_securite","nom":"Soupape de s√ªret√©","role":"Protection surpression","description":"Tar√©e; monte sur refoulement/r√©servoir."},
      {"id":"pressostat","nom":"Pressostat","role":"Commande marche/arr√™t","description":"Coupe moteur selon consigne (mode simple)."},
      {"id":"manometre_refoulement","nom":"Manom√®tre de refoulement","role":"Afficher pression sortie","description":"Lecture maintenance/diagnostic."},
      {"id":"thermometre_inter","nom":"Thermom√®tre intercooler","role":"Surveiller T¬∞ inter-√©tage","description":"Aide au diagnostic VE/refroidissement."},
      {"id":"volant","nom":"Volant/Flywheel","role":"Inertie + ventilation","description":"Pales de refroidissement int√©gr√©es."},
      {"id":"courroies","nom":"Courroies de transmission","role":"Transmettre puissance moteur‚Üípompe","description":"S√©lection selon poulies/puissance."},
      {"id":"poulie_moteur","nom":"Poulie moteur","role":"Adapter la vitesse","description":"Diam√®tre/stries selon courroies."},
      {"id":"poulie_pompe","nom":"Poulie pompe","role":"Adapter la vitesse pompe","description":"Doit correspondre au volant/rapport."},
      {"id":"garde_courroies","nom":"Garde-courroies","role":"S√©curit√©","description":"Emp√™che contact pi√®ces tournantes."},
      {"id":"joint_culasse","nom":"Joint de culasse","role":"√âtanch√©it√© t√™te/cylindre","description":"√Ä remplacer √† chaque d√©montage."},
      {"id":"kit_joints","nom":"Kit joints complet","role":"Maintenance p√©riodique","description":"Ensemble joints/consommables r√©vision."},
      {"id":"visserie_tete","nom":"Visserie de t√™te/cylindre","role":"Fixation t√™te/cylindre","description":"Couples de serrage √† respecter."},
      {"id":"vidange_reservoir","nom":"Robinet de purge r√©servoir","role":"√âvacuer condensats","description":"Entretien r√©servoir d‚Äôair."},
      {"id":"drain_intercooler","nom":"Purge intercooler","role":"√âvacuer condensats inter-√©tage","description":"√âvite eau dans cylindre HP."},
      {"id":"support_base","nom":"Ch√¢ssis / base support","role":"Supporter l‚Äôensemble","description":"Pad anti-vib., points d‚Äôancrage."},
      {"id":"silentblocs","nom":"Silentblocs","role":"Limiter vibrations","description":"Entre groupe et base."}
    ];

    /***********************
     * CANVAS & BACKGROUND *
     ***********************/
    const canvas = new fabric.Canvas('c', { selection:false, preserveObjectStacking:true, backgroundColor:'#0b1536' });
    let bgImg = null;
    let FIT_MODE = 'contain'; // contain | cover

    function resizeCanvas() {
      const stage = document.querySelector('.stage');
      canvas.setWidth(stage.clientWidth);
      canvas.setHeight(Math.max(540, window.innerHeight * 0.68));
      canvas.requestRenderAll();
    }
    window.addEventListener('resize', () => { resizeCanvas(); fitBackgroundImage(bgImg, true); });

    function fitBackgroundImage(img, keepZoom=false){
      if(!img) return;
      const cw = canvas.getWidth(), ch = canvas.getHeight(), iw = img.width, ih = img.height;
      const s = (FIT_MODE==='contain') ? Math.min(cw/iw, ch/ih) : Math.max(cw/iw, ch/ih);
      img.scale(s);
      img.set({ left:(cw - iw*s)/2, top:(ch - ih*s)/2, selectable:false, evented:false, id:'__BG__' });
      if(!keepZoom){ canvas.setZoom(1); document.getElementById('zoom').value = 100; }
      canvas.sendToBack(img);
      canvas.requestRenderAll();
    }

    function loadBackground(){
      fabric.Image.fromURL('actif/compresseur_bg.png', (img)=>{
        bgImg = img;
        canvas.add(img);
        fitBackgroundImage(img);
        // charger zones apr√®s que le fond soit positionn√©
        requestAnimationFrame(()=>{ loadSaved(); canvas.requestRenderAll(); });
      }, { crossOrigin:'anonymous' });
    }

    /***********************
     * ZONES & SAUVEGARDE  *
     ***********************/
    const LS_KEY = 'quincy310L_layout_v3';

    function toNormalized(obj){
      const w = bgImg.getScaledWidth(), h = bgImg.getScaledHeight();
      const bx = bgImg.left, by = bgImg.top;
      const r = obj.getBoundingRect(true, true);
      return {
        type:'rect',
        id: obj.pieceId ?? '',
        x:(r.left - bx)/w,
        y:(r.top  - by)/h,
        w:r.width / w,
        h:r.height / h
      };
    }

    function fromNormalized(z){
      const w = bgImg.getScaledWidth(), h = bgImg.getScaledHeight();
      const bx = bgImg.left, by = bgImg.top;
      const rect = new fabric.Rect({
        left: bx + z.x*w, top: by + z.y*h, width: z.w*w, height: z.h*h,
        fill:'rgba(0,255,0,.16)', stroke:'rgba(0,255,0,.95)', strokeWidth:2, rx:6, ry:6,
        selectable: isMoveMode, hasControls:true
      });
      rect.pieceId = z.id || '';
      canvas.add(rect);
      canvas.bringToFront(rect);
      return rect;
    }

    function save(){
      const zones = canvas.getObjects().filter(o=>o !== bgImg).map(toNormalized);
      localStorage.setItem(LS_KEY, JSON.stringify({ fit: FIT_MODE, zones }));
    }

    function loadSaved(){
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return;
      try{
        const data = JSON.parse(raw);
        if(data.fit) FIT_MODE = data.fit;
        (data.zones||[]).forEach(fromNormalized);
        refreshFitLabel();
      }catch(e){ console.warn('Aucune sauvegarde valide', e); }
    }

    function exportJSON(){
      const zones = canvas.getObjects().filter(o=>o !== bgImg).map(toNormalized);
      const blob = new Blob([JSON.stringify({ fit: FIT_MODE, zones }, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'quincy310L_zones.json';
      a.click();
    }

    function importJSON(file){
      if(!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const data = JSON.parse(reader.result);
          // reset zones
          canvas.getObjects().slice().forEach(o=>{ if(o !== bgImg) canvas.remove(o); });
          if(Array.isArray(data)){ // compat ancien: tableau simple en pixels
            const w = bgImg.getScaledWidth(), h = bgImg.getScaledHeight();
            const bx = bgImg.left, by = bgImg.top;
            data.forEach(z=>{
              const norm = { type:'rect', id:String(z.id||''), x:(z.x - bx)/w, y:(z.y - by)/h, w:z.w/w, h:z.h/h };
              fromNormalized(norm);
            });
          } else {
            FIT_MODE = data.fit || 'contain';
            (data.zones||[]).forEach(fromNormalized);
          }
          refreshFitLabel();
          canvas.requestRenderAll();
          save();
        }catch(e){ alert('JSON invalide.'); }
      };
      reader.readAsText(file);
    }

    /***********************
     * MODES & INTERACTIONS
     ***********************/
    let isDrawMode=false, isMoveMode=true, isPanMode=false, isSelectMode=false;
    let drawingRect=null, startPoint=null;

    function setActiveButton(id){
      document.querySelectorAll('.btn').forEach(b=>b.classList.remove('active'));
      const el = document.getElementById(id); if(el) el.classList.add('active');
    }
    function setMode({draw=false, move=false, pan=false, select=false}){
      isDrawMode=draw; isMoveMode=move; isPanMode=pan; isSelectMode=select;
      canvas.getObjects().forEach(o=>{ if(o !== bgImg) o.selectable = isMoveMode; });
    }

    // Dessin
    canvas.on('mouse:down', (opt)=>{
      if(isPanMode){
        canvas.isDragging = true;
        canvas.lastPosX = opt.e.clientX;
        canvas.lastPosY = opt.e.clientY;
        return;
      }
      if(!isDrawMode) return;
      const p = canvas.getPointer(opt.e);
      startPoint = p;
      drawingRect = new fabric.Rect({
        left:p.x, top:p.y, width:1, height:1,
        fill:'rgba(0,255,0,.16)', stroke:'rgba(0,255,0,.95)', strokeWidth:2, rx:6, ry:6, selectable:false
      });
      canvas.add(drawingRect);
    });

    canvas.on('mouse:move', (opt)=>{
      if(canvas.isDragging && isPanMode){
        const e = opt.e;
        const v = new fabric.Point(e.clientX - canvas.lastPosX, e.clientY - canvas.lastPosY);
        canvas.relativePan(v);
        canvas.lastPosX = e.clientX; canvas.lastPosY = e.clientY;
        return;
      }
      if(!isDrawMode || !drawingRect || !startPoint) return;
      const p = canvas.getPointer(opt.e);
      drawingRect.set({
        left: Math.min(p.x, startPoint.x),
        top : Math.min(p.y, startPoint.y),
        width: Math.abs(p.x - startPoint.x),
        height: Math.abs(p.y - startPoint.y)
      });
      canvas.requestRenderAll();
    });

    canvas.on('mouse:up', (e)=>{
      if(canvas.isDragging){ canvas.isDragging=false; return; }

      if(isSelectMode){
        const target = e.target;
        if(target && target !== bgImg){
          // mettre en valeur la zone cliqu√©e
          canvas.getObjects().forEach(o=>{ if(o !== bgImg) o.opacity = (o===target)?1:0.15; });
          canvas.requestRenderAll();
          fillPanelFromZone(target);
        }
      }

      if(!isDrawMode || !drawingRect) return;
      drawingRect.selectable = true;
      drawingRect = null; startPoint = null;
      save();
    });

    // Zoom (molette)
    canvas.on('mouse:wheel', (opt)=>{
      const delta = -opt.e.deltaY;
      const zoom = Math.max(0.25, Math.min(3, canvas.getZoom() * (1 + delta/1000)));
      canvas.zoomToPoint({ x: opt.e.offsetX, y: opt.e.offsetY }, zoom);
      document.getElementById('zoom').value = Math.round(zoom*100);
      opt.e.preventDefault(); opt.e.stopPropagation();
    });

    // Pinch-zoom mobile
    let lastDist=0;
    canvas.upperCanvasEl.addEventListener('touchstart',(e)=>{ if(e.touches.length===2) lastDist=getTouchDist(e); }, {passive:false});
    canvas.upperCanvasEl.addEventListener('touchmove',(e)=>{
      if(e.touches.length===2){
        e.preventDefault();
        const d=getTouchDist(e);
        if(lastDist){
          const factor = 1 + (d - lastDist)/300;
          const zoom = Math.max(0.25, Math.min(3, canvas.getZoom()*factor));
          canvas.zoomToPoint({ x:e.touches[0].clientX, y:e.touches[0].clientY }, zoom);
          document.getElementById('zoom').value = Math.round(zoom*100);
        }
        lastDist=d;
      }
    }, {passive:false});
    function getTouchDist(e){ const [a,b]=e.touches; return Math.hypot(a.clientX-b.clientX, a.clientY-b.clientY); }

    /***********************
     * PANNEAU & INVENTAIRE
     ***********************/
    function refreshInventorySelect(){
      const sel = document.getElementById('inventorySelect');
      sel.innerHTML = '<option value="">‚Äî S√©lectionne une pi√®ce ‚Äî</option>' +
        INVENTAIRE.map(p=>`<option value="${p.id}">${p.id} ‚Äî ${p.nom}</option>`).join('');
    }
    function showPart(id){
      const p = INVENTAIRE.find(x=>String(x.id)===String(id));
      document.getElementById('partName').value = p ? p.nom  : '';
      document.getElementById('partRole').value = p ? p.role : '';
      document.getElementById('partDesc').value = p ? p.description : '';
    }
    function fillPanelFromZone(zone){
      const id = zone.pieceId || '';
      document.getElementById('inventorySelect').value = id;
      showPart(id);
    }

    document.getElementById('inventorySelect').addEventListener('change', (e)=>{
      showPart(e.target.value);
    });

    document.getElementById('btn-apply').addEventListener('click', ()=>{
      const o = canvas.getActiveObject();
      if(!o || o===bgImg){ alert('S√©lectionne une zone.'); return; }
      const id = document.getElementById('inventorySelect').value;
      if(!id){ alert('Choisis une pi√®ce dans la liste.'); return; }
      o.pieceId = id;
      // afficher la fiche imm√©diatement
      showPart(id);
      save();
    });

    document.getElementById('btn-show-all').addEventListener('click', ()=>{
      canvas.getObjects().forEach(o=>{ if(o!==bgImg) o.opacity = 1; });
      canvas.requestRenderAll();
    });

    /***********************
     * UI BOUTONS
     ***********************/
    function refreshFitLabel(){
      document.getElementById('toggle-fit').innerHTML = `Mode: <strong>${FIT_MODE==='contain'?'Tout voir':'Remplir'}</strong>`;
    }

    document.getElementById('btn-move').addEventListener('click', ()=>{ setMode({move:true}); setActiveButton('btn-move'); });
    document.getElementById('btn-draw').addEventListener('click', ()=>{ setMode({draw:true}); setActiveButton('btn-draw'); });
    document.getElementById('btn-pan').addEventListener('click',  ()=>{ setMode({pan:true});  setActiveButton('btn-pan');  });
    document.getElementById('btn-select').addEventListener('click',()=>{ setMode({select:true}); setActiveButton('btn-select'); });

    document.getElementById('btn-delete').addEventListener('click', ()=>{
      const o = canvas.getActiveObject();
      if(o && o!==bgImg){ canvas.remove(o); save(); }
    });

    document.getElementById('btn-clear').addEventListener('click', ()=>{
      if(!confirm('Effacer toutes les zones ?')) return;
      canvas.getObjects().slice().forEach(o=>{ if(o!==bgImg) canvas.remove(o); });
      save();
    });

    document.getElementById('zoom').addEventListener('input', (e)=>{
      const z = Math.max(0.25, Math.min(3, Number(e.target.value)/100));
      canvas.setZoom(z);
      canvas.requestRenderAll();
    });

    document.getElementById('toggle-fit').addEventListener('click', ()=>{
      FIT_MODE = (FIT_MODE==='contain') ? 'cover' : 'contain';
      refreshFitLabel();
      fitBackgroundImage(bgImg);
      save();
    });

    document.getElementById('btn-fit').addEventListener('click', ()=>{
      fitBackgroundImage(bgImg);
    });

    document.getElementById('btn-export').addEventListener('click', exportJSON);
    document.getElementById('fileImport').addEventListener('change', (e)=>{ importJSON(e.target.files[0]); e.target.value=''; });

    /***********************
     * BOOT
     ***********************/
    resizeCanvas();
    loadBackground();
    refreshInventorySelect();
    setMode({move:true}); setActiveButton('btn-move');
  </script>
</body>
</html>
