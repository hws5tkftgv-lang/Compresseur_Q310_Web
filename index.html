
<!doctype html>
<html lang="fr" translate="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Compresseur – Hotspots PRO</title>
  <link rel="icon" href="data:," />
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>
  <style>
    :root{ --bg:#0b1025; --panel:#0f1738; --accent:#243167; --text:#e9eefc; --muted:#9fb2e6; --btn:#334155; --ok:#16a34a; --warn:#b91c1c; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui, Segoe UI, Arial, sans-serif}
    header{padding:14px 18px;background:#11183a;border-bottom:1px solid var(--accent);font-weight:700}
    .container{display:grid;grid-template-columns:1fr 380px;gap:16px;padding:16px}
    .card{background:var(--panel);border:1px solid var(--accent);border-radius:12px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;padding:12px;border-bottom:1px solid var(--accent)}
    .btn{background:var(--btn);color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer}
    .btn.primary{background:#2563eb}
    .btn.ok{background:var(--ok)}
    .btn.warn{background:var(--warn)}
    .spacer{flex:1}
    .pad{padding:12px}
    label{display:block;margin:10px 0 6px;color:var(--muted)}
    input[type="text"], select, textarea{width:100%;background:#0c1433;color:var(--text);border:1px solid var(--accent);border-radius:8px;padding:10px;outline:none}
    textarea{min-height:120px;resize:vertical}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .kbd{background:#101a42;padding:2px 6px;border-radius:6px;border:1px solid var(--accent)}
    .hint{color:var(--muted);font-size:13px}
    .legend{padding:8px 12px;border-top:1px solid var(--accent);color:var(--muted)}
    @media (max-width:980px){ .container{grid-template-columns:1fr} }
    /* tactile : on gère les gestes nous-mêmes dans le canvas */
    canvas, #c, .canvas-container{ -webkit-user-select:none; -webkit-touch-callout:none; touch-action:none; }
  </style>
</head>
<body>
  <header>🧰 Compresseur – Schéma interactif (PRO)</header>

  <main class="container">
    <!-- Canvas & outils -->
    <section class="card" id="canvasCard">
      <div class="toolbar">
        <button id="mode-draw" class="btn primary">✏️ Dessiner</button>
        <button id="mode-select" class="btn">🖐️ Déplacer/Redim.</button>
        <button id="mode-pan" class="btn">🖱️ Pan</button>

        <button id="btn-delete" class="btn">🗑️ Supprimer sel.</button>
        <button id="btn-clear" class="btn">🧹 Effacer tout</button>

        <button id="toggle-fit" class="btn">Mode: Tout voir</button>
        <button id="btn-fit" class="btn">🔍 Ajuster à l’écran</button>

        <span class="spacer"></span>

        <label class="hint" style="display:flex;align-items:center;gap:6px">
          Zoom :
          <input type="range" id="zoom" min="50" max="250" value="100">
        </label>

        <label class="hint"><input id="snap" type="checkbox" checked> Magnétisme 8px</label>

        <button id="btn-save" class="btn ok">💾 Export JSON</button>
        <label class="btn" style="cursor:pointer">📥 Importer JSON
          <input id="file-load" type="file" accept="application/json" style="display:none">
        </label>

        <button id="btn-screenshot" class="btn">📸 PNG</button>
        <button id="stopServerBtn" class="btn warn">🟥 Arrêter le serveur</button>
      </div>

      <div class="pad">
        <canvas id="c" width="1100" height="700"></canvas>
      </div>

      <div class="legend pad">
        Astuce : <span class="kbd">Shift</span> = carré • <span class="kbd">Ctrl/Cmd</span> + molette = zoom • Double-clic zone = charger la fiche • <span class="kbd">2 doigts</span> = pinch-zoom + pan.
      </div>
    </section>

    <!-- Panneau de droite -->
    <aside class="card">
      <div class="pad">
        <h2 style="margin:6px 0 2px">📄 Fiche zone</h2>
        <small class="hint">Sélectionne un rectangle sur l’image.</small>

        <label>Pièce (inventaire Quincy 310L)
          <select id="part-select"><option value="">— Sélectionne une pièce —</option></select>
        </label>

        <label>Titre
          <input id="title-input" type="text" placeholder="Titre de la zone">
        </label>

        <label>Description / Rôle
          <textarea id="desc-input" placeholder="Texte explicatif…"></textarea>
        </label>

        <div class="grid2" style="margin-top:8px">
          <button id="apply-meta" class="btn ok">✅ Appliquer à la zone</button>
          <button id="center-view" class="btn">🎯 Centrer la zone</button>
        </div>

        <hr style="border:0;border-top:1px solid var(--accent);margin:16px 0">

        <h3 style="margin:0 0 8px">🔧 Outils</h3>
        <div class="grid2">
          <button id="clear-filter" class="btn">Afficher toutes les zones</button>
        </div>

        <p class="hint" style="margin-top:12px">Autosave : enregistrement local automatique (navigateur).</p>
      </div>
    </aside>
  </main>

  <!-- =================== LOGIQUE (clé en main) =================== -->
  <script>
  (function(){
    const $ = (id) => document.getElementById(id);

    // ---------- Constantes ----------
    const BG_URL = "actif/compresseur_bg.png";
    const SNAP = 8;
    const LS_KEY = "hotspots_pro_autosave_v1";
    let FIT_MODE = "contain";               // "contain" (tout voir) / "cover" (remplir)
    const ZOOM_MIN = 0.5, ZOOM_MAX = 2.5;   // limites pour pinch + slider

    // ---------- Canvas ----------
    const canvas = new fabric.Canvas("c", {
      backgroundColor:"#0a1330",
      selection:true,
      preserveObjectStacking:true
    });
    canvas.allowTouchScrolling = true;

    let zoom = 1;
    function setZoom(z){
      zoom = Math.min(ZOOM_MAX, Math.max(ZOOM_MIN, z));
      canvas.setZoom(zoom);
      $("zoom").value = Math.round(zoom * 100);
      canvas.requestRenderAll();
    }
    function gSnap(v){ return $("snap").checked ? Math.round(v/SNAP)*SNAP : v; }
    function rectMeta(o){ return o?.data || (o.data={partId:"", title:"", description:""}); }

    // ---------- Image de fond ----------
    function fitBackgroundImage(img){
      const cw = canvas.getWidth(), ch = canvas.getHeight();
      const scale = (FIT_MODE === "cover")
        ? Math.max(cw / img.width, ch / img.height)
        : Math.min(cw / img.width, ch / img.height);
      const w = img.width * scale, h = img.height * scale;
      img.set({ left:(cw - w)/2, top:(ch - h)/2, selectable:false, evented:false });
      img.scale(scale); img.set("id","__BG__"); img.setCoords();
    }
    function removeOldBackgrounds(){
      canvas.getObjects('image').forEach(o=>{
        if (o.id === '__BG__' || o._isBG === true) canvas.remove(o);
      });
    }
    function loadBackground(){
      removeOldBackgrounds();
      fabric.Image.fromURL(BG_URL, (img)=>{
        img._isBG = true;
        fitBackgroundImage(img);
        canvas.add(img); img.sendToBack();
        canvas.requestRenderAll();
        loadAutosave(); // zones après l'image
      }, { crossOrigin: "anonymous" });
    }

    // ---------- Inventaire ----------
    let INVENTORY = [];
    fetch("quincy_310L_parts.json")
      .then(r=>r.json())
      .then(data=>{
        INVENTORY = data || [];
        const s = $("part-select");
        s.innerHTML =
          '<option value="">— Sélectionne une pièce —</option>' +
          INVENTORY.map(p => `<option value="${p.id ?? ""}">${p.code ? (p.code+' — ') : ''}${p.nom ?? ''}</option>`).join("");
      })
      .catch(()=>{}); // silencieux

    // ---------- Surlignage par pièce ----------
    function highlightByPart(partId){
      const has = !!partId;
      canvas.getObjects().forEach(o=>{
        if(o.type !== "rect") return;
        const match = (o.data?.partId || "") === partId;
        o.set({ opacity: has ? (match ? 1 : 0.15) : 1, stroke: match ? "#22c55e" : "#ff4d4d" });
      });
      canvas.requestRenderAll();
    }
    $("part-select").addEventListener("change", ()=>{
      const value = $("part-select").value;
      const piece = INVENTORY.find(p => String(p.id) === String(value));
      if (piece) {
        $("title-input").value = piece.nom || "";
        const role = piece.role || piece.rôle || "";
        const desc = piece.description || piece.desc || "";
        $("desc-input").value = [role, desc].filter(Boolean).join(" — ");
      }
      highlightByPart(value || "");
    });
    $("clear-filter").addEventListener("click", ()=>{
      $("part-select").value = ""; highlightByPart("");
    });

    // ---------- Modes (dessin / sélection / pan bouton) ----------
    let drawMode = true;
    function setDraw(){ drawMode=true; $("mode-draw").classList.add("primary"); $("mode-select").classList.remove("primary"); $("mode-pan").classList.remove("primary"); canvas.skipTargetFind=false; canvas.defaultCursor="default"; }
    function setSelect(){ drawMode=false; $("mode-draw").classList.remove("primary"); $("mode-select").classList.add("primary"); $("mode-pan").classList.remove("primary"); canvas.skipTargetFind=false; canvas.defaultCursor="default"; }
    $("mode-draw").onclick=setDraw; $("mode-select").onclick=setSelect; setDraw();

    // ---------- Pan libre (bouton) ----------
    let panMode = false, isDragging = false, lastX = 0, lastY = 0;
    function getPoint(e){ return e.touches && e.touches[0] ? {x:e.touches[0].clientX, y:e.touches[0].clientY} : {x:e.clientX, y:e.clientY}; }
    $("mode-pan").addEventListener("click", ()=>{
      panMode = !panMode;
      $("mode-pan").classList.toggle("primary", panMode);
      drawMode = false;
      $("mode-draw").classList.remove("primary");
      $("mode-select").classList.remove("primary");
      canvas.skipTargetFind = panMode; // éviter d’attraper des rectangles
      canvas.defaultCursor  = panMode ? "grab" : "default";
      canvas.hoverCursor    = panMode ? "grab" : "move";
    });
    canvas.on("mouse:down",(opt)=>{
      if(!panMode) return;
      isDragging = true;
      const p = getPoint(opt.e);
      lastX = p.x; lastY = p.y;
      canvas.setCursor("grabbing");
      canvas.requestRenderAll();
    });
    canvas.on("mouse:move",(opt)=>{
      if(!panMode || !isDragging) return;
      const p = getPoint(opt.e);
      const dx = p.x - lastX, dy = p.y - lastY;
      lastX = p.x; lastY = p.y;
      canvas.relativePan(new fabric.Point(dx, dy));
    });
    canvas.on("mouse:up",()=>{
      if(!panMode) return;
      isDragging = false;
      canvas.setCursor("grab");
    });

    // ---------- Pinch-zoom + pan (2 doigts) ----------
    let touchStartZoom = 1, pinchPrev = null;
    function touchInfo(e){
      const t = e.touches; if(!t || t.length < 2) return null;
      const x1=t[0].clientX, y1=t[0].clientY, x2=t[1].clientX, y2=t[1].clientY;
      const cx=(x1+x2)/2, cy=(y1+y2)/2;
      const dist=Math.hypot(x2-x1, y2-y1);
      return {cx, cy, dist};
    }
    canvas.upperCanvasEl.addEventListener("touchstart",(e)=>{
      if(e.touches.length===2){
        e.preventDefault();
        pinchPrev = touchInfo(e);
        touchStartZoom = zoom;
      }
    }, {passive:false});
    canvas.upperCanvasEl.addEventListener("touchmove",(e)=>{
      if(e.touches.length===2 && pinchPrev){
        e.preventDefault();
        const now = touchInfo(e); if(!now) return;
        // Zoom relatif
        const scale = now.dist / pinchPrev.dist;
        const targetZoom = Math.min(ZOOM_MAX, Math.max(ZOOM_MIN, touchStartZoom * scale));
        const point = new fabric.Point(now.cx, now.cy);
        canvas.zoomToPoint(point, targetZoom);
        zoom = targetZoom;
        $("zoom").value = Math.round(zoom * 100);
        // Pan selon déplacement du centre
        const dx = now.cx - pinchPrev.cx, dy = now.cy - pinchPrev.cy;
        canvas.relativePan(new fabric.Point(dx, dy));
        pinchPrev = now;
      }
    }, {passive:false});
    canvas.upperCanvasEl.addEventListener("touchend",(e)=>{
      if(e.touches.length < 2) pinchPrev = null;
    }, {passive:false});

    // ---------- Dessin rectangles ----------
    let start=null, temp=null;
    canvas.on("mouse:down",(opt)=>{
      if(!drawMode || panMode || (opt.e.touches && opt.e.touches.length===2)) return;
      const p=canvas.getPointer(opt.e);
      start=p;
      temp=new fabric.Rect({
        left:p.x, top:p.y, width:1, height:1,
        fill:"rgba(255,0,0,0.22)", stroke:"#ff4d4d", strokeWidth:2,
        selectable:true, hasControls:true, hasBorders:true
      });
      canvas.add(temp);
    });
    canvas.on("mouse:move",(opt)=>{
      if(!drawMode || panMode || !temp || !start) return;
      const p=canvas.getPointer(opt.e);
      const x=Math.min(p.x,start.x), y=Math.min(p.y,start.y);
      const w=Math.abs(p.x-start.x), h=Math.abs(p.y-start.y);
      temp.set({left:x, top:y, width:w, height:h}); canvas.requestRenderAll();
    });
    canvas.on("mouse:up",()=>{
      if(!drawMode || panMode || !temp) return;
      temp.set({left:gSnap(temp.left), top:gSnap(temp.top), width:gSnap(temp.width), height:gSnap(temp.height)});
      temp.setCoords(); temp=null; start=null; autosave();
    });

    // Snap déplacements/redim + save
    canvas.on("object:moving", e=>{
      const o=e.target; if(o && o.id!=="__BG__"){ o.left=gSnap(o.left); o.top=gSnap(o.top);}
    });
    canvas.on("object:scaling", e=>{
      const o=e.target; if(o && o.id!=="__BG__"){
        o.width=gSnap(o.width*o.scaleX); o.height=gSnap(o.height*o.scaleY);
        o.scaleX=1; o.scaleY=1; o.setCoords();
      }
    });
    canvas.on("object:modified", e=>{ const o=e.target; if(o && o.type==="rect") autosave(); });

    // Double-clic = charger fiche
    canvas.on("mouse:dblclick",(e)=>{
      if(panMode) return;
      const obj=canvas.findTarget(e.e,true);
      if(obj && obj.type==="rect"){
        canvas.setActiveObject(obj);
        const m=rectMeta(obj);
        $("title-input").value=m.title||"";
        $("desc-input").value=m.description||"";
        $("part-select").value=m.partId||"";
      }
    });

    // Panneau
    $("apply-meta").onclick=()=>{
      const o=canvas.getActiveObject(); if(!o || o.type!=="rect"){ alert("Sélectionne une zone."); return; }
      const m=rectMeta(o);
      m.partId=$("part-select").value; m.title=$("title-input").value; m.description=$("desc-input").value;
      highlightByPart($("part-select").value || "");
      autosave();
    };
    $("center-view").onclick=()=>{
      const o=canvas.getActiveObject(); if(!o) return;
      const cx=o.left+o.width/2, cy=o.top+o.height/2;
      canvas.absolutePan({x:cx-canvas.getWidth()/2, y:cy-canvas.getHeight()/2});
    };

    // Toolbar
    $("btn-delete").onclick=()=>{ const o=canvas.getActiveObject(); if(o && o.type==="rect"){ canvas.remove(o); autosave(); } };
    $("btn-clear").onclick =()=>{ canvas.getObjects().filter(o=>o.type==="rect").forEach(o=>canvas.remove(o)); autosave(); };
    $("zoom").oninput     =(e)=> setZoom(Number(e.target.value)/100);

    // Ajuster à l’écran selon mode courant
    $("btn-fit").onclick=()=>{ const bg=canvas.getObjects().find(o=>o.id==="__BG__"); if(!bg) return; fitBackgroundImage(bg); canvas.requestRenderAll(); autosave(); };

    // Basculer contain/cover
    const toggleBtn = $("toggle-fit");
    function refreshToggleLabel(){ if(toggleBtn){ toggleBtn.textContent = (FIT_MODE==='contain') ? 'Mode: Tout voir' : 'Mode: Remplir'; } }
    toggleBtn.addEventListener('click', ()=>{
      FIT_MODE = (FIT_MODE==='contain') ? 'cover' : 'contain';
      refreshToggleLabel();
      const bg=canvas.getObjects().find(o=>o.id==='__BG__');
      if(bg){ fitBackgroundImage(bg); canvas.requestRenderAll(); autosave(); }
    });
    refreshToggleLabel();

    // Capture PNG
    $("btn-screenshot").onclick=()=>{
      canvas.discardActiveObject(); canvas.requestRenderAll();
      const data=canvas.toDataURL({format:"png"});
      const a=document.createElement("a"); a.href=data; a.download="hotspots_capture.png"; a.click();
    };

    // ---------- Export / Import JSON ----------
    function exportJSON(){
      const bg=canvas.getObjects().find(o=>o.id==="__BG__");
      const rects=canvas.getObjects().filter(o=>o.type==="rect");
      const ow=bg?bg.width*bg.scaleX:canvas.getWidth();
      const oh=bg?bg.height*bg.scaleY:canvas.getHeight();
      return {
        image:BG_URL,
        canvas_size:{w:canvas.getWidth(),h:canvas.getHeight()},
        base_size:{w:ow,h:oh},
        items: rects.map((r,i)=>({
          id:`zone_${i+1}`,
          x:r.left/ow, y:r.top/oh, w:r.width/ow, h:r.height/oh,
          meta:rectMeta(r)
        }))
      };
    }
    // import robuste (ancien px OU normalisé 0..1)
    function importJSON(data){
      const bg  = canvas.getObjects().find(o => o.id === "__BG__");
      const ow  = bg ? bg.width  * bg.scaleX : canvas.getWidth();
      const oh  = bg ? bg.height * bg.scaleY : canvas.getHeight();

      let items = data?.items || data?.zones || data;
      if (!Array.isArray(items)) { alert("JSON non reconnu (pas de 'items')."); return; }

      // efface zones actuelles
      canvas.getObjects().filter(o=>o.type==="rect").forEach(o=>canvas.remove(o));

      items.forEach((it)=>{
        let x = it.x ?? it.left ?? it.l ?? 0;
        let y = it.y ?? it.top  ?? it.t ?? 0;
        let w = it.w ?? it.width  ?? it.wd ?? 0;
        let h = it.h ?? it.height ?? it.ht ?? 0;
        const looksAbs = (x>1 || y>1 || w>1 || h>1);
        if (!looksAbs) { x*=ow; y*=oh; w*=ow; h*=oh; }

        const r=new fabric.Rect({
          left:x, top:y, width:w, height:h,
          fill:"rgba(255,0,0,0.22)", stroke:"#ff4d4d", strokeWidth:2,
          selectable:true, hasControls:true, hasBorders:true
        });
        r.data = it.meta || { partId: it.partId || "", title: it.title || "", description: it.description || it.desc || "" };
        canvas.add(r);
      });

      canvas.requestRenderAll();
      autosave();
    }

    $("btn-save").onclick=()=>{
      const data=exportJSON();
      const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download="hotspots_export.json";
      a.click();
      URL.revokeObjectURL(a.href);
    };
    $("file-load").onchange=(ev)=>{
      const f=ev.target.files[0]; if(!f) return;
      f.text().then(txt=>{
        try{ importJSON(JSON.parse(txt)); }
        catch(e){ alert("JSON invalide : "+e.message); }
      });
    };

    // ---------- Autosave ----------
    function autosave(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(exportJSON())); }catch{} }
    function loadAutosave(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return;
        const data = JSON.parse(raw);
        if(data?.image && data.image !== BG_URL) return; // ignore si image changée
        importJSON(data);
      }catch{}
    }

    // ---------- Démarrage / Resize ----------
    loadBackground();
    window.addEventListener("resize", ()=>{
      const bg=canvas.getObjects().find(o=>o.id==="__BG__");
      if(!bg) return;
      fitBackgroundImage(bg); canvas.requestRenderAll();
    }, {passive:true});

    // ---------- Masquer "Arrêter le serveur" hors local ----------
    const ON_LOCAL = location.hostname === "localhost" || location.hostname === "127.0.0.1";
    const stopBtn = $("stopServerBtn");
    if (stopBtn && !ON_LOCAL) stopBtn.style.display = "none";
  })();
  </script>
</body>
</html>
