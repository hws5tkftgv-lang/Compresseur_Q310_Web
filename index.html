<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Compresseur ‚Äì Sch√©ma interactif (PRO)</title>

  <!-- Styles externes -->
  <link rel="stylesheet" href="styles.css" />

  <!-- Styles minimaux de secours -->
  <style>
    :root { color-scheme: dark; }
    body { margin: 0; background:#0e1730; color:#dfe7ff; font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif; }
    .toolbar { display:flex; flex-wrap:wrap; gap:.5rem; align-items:center; padding:12px 16px; }
    .btn { padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:#1a2548; color:#eaf1ff; cursor:pointer; }
    .btn:hover { filter:brightness(1.05); }
    .btn.primary { background:#1f3b91; }
    .btn.danger { background:#8c2130; }
    .btn.success { background:#1e7a34; }
    .btn.active { background:#0078ff; color:#fff; font-weight:700; border:2px solid #004a9f; box-shadow:0 0 6px rgba(0,120,255,.7); }
    .hidden { display:none !important; }
    .wrap { display:grid; grid-template-columns: 1fr 360px; gap:16px; padding:12px 12px 16px; }
    @media (max-width: 1100px){ .wrap{ grid-template-columns:1fr; } }
    .stage { background:#0d1530; border:1px solid rgba(255,255,255,.08); border-radius:12px; overflow:hidden; min-height:60vh; }
    .panel { background:#0f1a3a; border:1px solid rgba(255,255,255,.1); border-radius:12px; padding:12px; }
    .panel h3 { margin:6px 0 12px; }
    .row { margin:8px 0; display:flex; flex-direction:column; gap:6px; }
    label { font-size:.9rem; opacity:.9; }
    select, input[type="text"], textarea { width:100%; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.15); background:#0b1533; color:#eaf1ff; }
    textarea { min-height:140px; resize:vertical; }
    .small { font-size:.8rem; opacity:.7; }
    .spacer { flex:1; }
    .chip { padding:6px 10px; background:#1a2548; border-radius:10px; border:1px solid rgba(255,255,255,.12);}
    .hr { height:1px; background:rgba(255,255,255,.08); margin:10px 0;}
  </style>

  <!-- FabricJS -->
  <script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>
</head>
<body>

  <!-- Barre d‚Äôoutils -->
  <div class="toolbar">
    <button id="btn-draw" class="btn primary">‚úèÔ∏è Dessiner</button>
    <button id="btn-move" class="btn">üßø D√©placer/Redim.</button>
    <button id="btn-pan" class="btn">‚úã Pan</button>
    <button id="btn-select" class="btn">üñ±Ô∏è S√©lection</button>
    <button id="btn-delete" class="btn">üóëÔ∏è Supprimer sel.</button>
    <button id="btn-clear" class="btn">üßº Effacer tout</button>

    <span id="toggle-fit" class="btn chip">Mode: <strong>Tout voir</strong></span>
    <button id="btn-fit" class="btn">üñºÔ∏è Ajuster √† l‚Äô√©cran</button>

    <span class="chip">Zoom : <input id="zoom" type="range" min="25" max="300" step="1" value="100" /></span>
    <label class="chip">Magn√©tisme <span id="gridVal">8</span>px <input id="gridSlider" type="range" min="0" max="32" step="1" value="8" /></label>

    <span class="spacer"></span>

    <button id="btn-export" class="btn success">üíæ Export JSON</button>
    <label class="btn">
      üì• Importer JSON
      <input id="fileImport" type="file" accept=".json,application/json" style="display:none" />
    </label>
    <button id="btn-screenshot" class="btn">üñ®Ô∏è PNG</button>
    <button id="btn-stop-server" class="btn danger hidden">‚õî Arr√™ter le serveur</button>
  </div>

  <!-- Zone + panneau -->
  <div class="wrap">
    <div class="stage">
      <canvas id="c"></canvas>
    </div>

    <aside class="panel">
      <h3>üìò Fiche zone</h3>
      <p class="small">S√©lectionne un rectangle sur l‚Äôimage ou clique une zone en mode <strong>S√©lection</strong>.</p>

      <div class="row">
        <label for="inventorySelect">Pi√®ce (inventaire Quincy 310L)</label>
        <select id="inventorySelect">
          <option value="">‚Äî S√©lectionne une pi√®ce ‚Äî</option>
        </select>
      </div>

      <div class="row">
        <label for="partTitle">Titre</label>
        <input id="partTitle" type="text" placeholder="Titre de la zone" />
      </div>

      <div class="row">
        <label for="partDescription">Description / R√¥le</label>
        <textarea id="partDescription" placeholder="Texte explicatif‚Ä¶"></textarea>
      </div>

      <div class="row" style="display:flex; gap:8px;">
        <button id="btn-apply" class="btn success" style="flex:1;">‚úÖ Appliquer √† la zone</button>
        <button id="btn-center" class="btn" style="flex:1;">üéØ Centrer la zone</button>
      </div>

      <div class="hr"></div>

      <div class="row">
        <button id="btn-show-all" class="btn">üëÅÔ∏è Afficher toutes les zones</button>
        <span class="small">Autosave : enregistrement local automatique (navigateur).</span>
      </div>
    </aside>
  </div>

  <script>
    // ================== STATE & CONST ==================
    const canvas = new fabric.Canvas('c', {
      backgroundColor: '#0b1533',
      selection: false,
      preserveObjectStacking: true
    });

    // Taille initiale
    function resizeCanvasToStage() {
      const stage = document.querySelector('.stage');
      canvas.setWidth(stage.clientWidth);
      canvas.setHeight(Math.max(520, window.innerHeight * 0.65));
      canvas.requestRenderAll();
    }
    window.addEventListener('resize', () => {
      resizeCanvasToStage();
      fitBackgroundImage(bgImgRef, true);
    });

    let FIT_MODE = 'contain'; // 'contain' | 'cover'
    let isDrawing = false;
    let isMoveMode = false;
    let isPanMode = false;
    let isSelectMode = false;

    let drawingRect = null;
    let startPoint = null;
    let bgImgRef = null;
    let zoomLevel = 1;
    let gridSize = 8; // px
    const LS_KEY = 'quincy_310L_layout_v2';

    // ================== UTILS ==================
    function setActiveButton(id) {
      document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
      const el = document.getElementById(id);
      if (el) el.classList.add('active');
    }

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function toNormalized(obj) {
      // Sauvegarde normalis√©e 0..1 (zone relative au fond)
      const bg = bgImgRef;
      const w = bg ? bg.getScaledWidth() : canvas.getWidth();
      const h = bg ? bg.getScaledHeight() : canvas.getHeight();
      const bx = bg ? bg.left : 0;
      const by = bg ? bg.top  : 0;
      const r = obj.getBoundingRect(true, true);
      return {
        type: 'rect',
        x: (r.left - bx) / w,
        y: (r.top  - by) / h,
        w: r.width / w,
        h: r.height / h,
        pieceId: obj.pieceId ?? null,
        title: obj.title ?? '',
        desc: obj.desc ?? ''
      };
    }

    function fromNormalized(z) {
      const bg = bgImgRef;
      const w = bg.getScaledWidth();
      const h = bg.getScaledHeight();
      const bx = bg.left;
      const by = bg.top;
      const left = bx + z.x * w;
      const top  = by + z.y * h;
      const width  = z.w * w;
      const height = z.h * h;

      const rect = new fabric.Rect({
        left, top, width, height,
        fill: 'rgba(0, 255, 0, 0.15)',
        stroke: 'rgba(0,255,0,0.9)',
        strokeWidth: 2,
        rx: 6, ry: 6,
        selectable: isMoveMode,
        hasControls: true
      });
      rect.pieceId = z.pieceId ?? null;
      rect.title = z.title ?? '';
      rect.desc = z.desc ?? '';
      canvas.add(rect);
      canvas.bringToFront(rect);
      return rect;
    }

    function save() {
      const zones = canvas.getObjects().filter(o => o !== bgImgRef).map(toNormalized);
      const payload = { fit: FIT_MODE, zones };
      localStorage.setItem(LS_KEY, JSON.stringify(payload));
    }

    function loadSaved() {
      try {
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return;
        const data = JSON.parse(raw);
        if (data.fit) FIT_MODE = data.fit;
        (data.zones || []).forEach(fromNormalized);
        refreshToggleLabel();
      } catch(e){ console.warn('No saved layout', e); }
    }

    function exportJSON() {
      const zones = canvas.getObjects().filter(o => o !== bgImgRef).map(toNormalized);
      const blob = new Blob([JSON.stringify({ fit: FIT_MODE, zones }, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'quincy_310L_layout.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    function importJSON(file) {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          // reset zones
          canvas.getObjects().slice().forEach(o => { if (o !== bgImgRef) canvas.remove(o); });
          // compat: pixels anciens => d√©tecter si valeurs > 1
          if (Array.isArray(data)) {
            // ancien format: tableau simple
            (data || []).forEach(z => {
              // supposer pixels ‚Üí normaliser contre le fond actuel
              const w = bgImgRef.getScaledWidth();
              const h = bgImgRef.getScaledHeight();
              const bx = bgImgRef.left, by = bgImgRef.top;
              const norm = {
                type:'rect',
                x: (z.x - bx)/w, y:(z.y - by)/h, w: z.w/w, h: z.h/h,
                pieceId: z.pieceId ?? null, title: z.title ?? '', desc: z.desc ?? ''
              };
              fromNormalized(norm);
            });
          } else {
            // nouveau format {fit, zones}
            FIT_MODE = data.fit || 'contain';
            (data.zones || []).forEach(fromNormalized);
          }
          refreshToggleLabel();
          canvas.requestRenderAll();
          save();
        } catch(e){
          alert('Fichier JSON invalide.');
        }
      };
      reader.readAsText(file);
    }

    // ================== BACKGROUND ==================
    function fitBackgroundImage(img, keepZoom=false) {
      if (!img) return;
      const cw = canvas.getWidth(), ch = canvas.getHeight();
      const iw = img.width, ih = img.height;
      const scale = (FIT_MODE === 'contain')
        ? Math.min(cw / iw, ch / ih)
        : Math.max(cw / iw, ch / ih);
      img.scale(scale);
      img.set({
        left: (cw - iw * scale) / 2,
        top : (ch - ih * scale) / 2,
        selectable: false,
        evented: false
      });
      if (!keepZoom) {
        zoomLevel = 1;
        canvas.setZoom(1);
        canvas.requestRenderAll();
        document.getElementById('zoom').value = 100;
      }
    }

    function refreshToggleLabel(){
      const e = document.getElementById('toggle-fit');
      e.innerHTML = `Mode: <strong>${FIT_MODE === 'contain' ? 'Tout voir' : 'Remplir'}</strong>`;
    }

    function loadBackground() {
      fabric.Image.fromURL('actif/compresseur_bg.png', (img) => {
        img.set({ id: '__BG__' });
        bgImgRef = img;
        canvas.add(img);
        canvas.sendToBack(img);
       fitBackgroundImage(img);
setTimeout(() => {
  loadSaved();
  canvas.requestRenderAll();
}, 200);

      }, { crossOrigin: 'anonymous' });
    }

    // ================== INVENTAIRE ==================
    let INVENTAIRE_QUINCY_310L = [];
    async function loadInventory() {
      try {
        const res = await fetch('./quincy_310L_parts.json', { cache: 'no-store' });
        INVENTAIRE_QUINCY_310L = await res.json();
        const sel = document.getElementById('inventorySelect');
        sel.innerHTML = '<option value="">‚Äî S√©lectionne une pi√®ce ‚Äî</option>' +
          INVENTAIRE_QUINCY_310L.map(p=>`<option value="${p.id}">${p.code ? '['+p.code+'] ' : ''}${p.nom || p.name}</option>`).join('');
      } catch(e){
        console.warn('Inventaire non charg√©', e);
      }
    }

    function applyPanelTo(obj) {
      if (!obj) return;
      const id = document.getElementById('inventorySelect').value;
      const title = document.getElementById('partTitle').value || '';
      const desc  = document.getElementById('partDescription').value || '';
      obj.pieceId = id ? Number(id) : null;
      obj.title = title;
      obj.desc = desc;
      save();
      canvas.requestRenderAll();
    }

    // ================== MODES & INTERACTIONS ==================
    function setMode({draw=false, move=false, pan=false, select=false}) {
      isDrawing = draw;
      isMoveMode = move;
      isPanMode = pan;
      isSelectMode = select;

      // S√©lectabilit√© des zones
      canvas.getObjects().forEach(o => {
        if (o === bgImgRef) return;
        o.selectable = isMoveMode;
        o.evented = !isMoveMode || isSelectMode || isPanMode;
      });

      // Curseur
      canvas.defaultCursor = isPanMode ? 'grab' : 'default';
      canvas.hoverCursor = isSelectMode ? 'pointer' : 'move';
    }

    // Dessin de rectangles
    canvas.on('mouse:down', (opt) => {
      if (isPanMode) {
        canvas.defaultCursor = 'grabbing';
        canvas.isDragging = true;
        canvas.lastPosX = opt.e.clientX;
        canvas.lastPosY = opt.e.clientY;
        return;
      }
      if (!isDrawing) return;

      const p = canvas.getPointer(opt.e);
      startPoint = p;
      drawingRect = new fabric.Rect({
        left: p.x, top: p.y, width: 1, height: 1,
        fill:'rgba(0,255,0,0.15)', stroke:'rgba(0,255,0,0.9)', strokeWidth:2,
        rx:6, ry:6, selectable:false
      });
      canvas.add(drawingRect);
    });

    canvas.on('mouse:move', (opt) => {
      if (canvas.isDragging && isPanMode) {
        const e = opt.e;
        const v = new fabric.Point(e.clientX - canvas.lastPosX, e.clientY - canvas.lastPosY);
        canvas.relativePan(v);
        canvas.lastPosX = e.clientX; canvas.lastPosY = e.clientY;
        return;
      }

      if (!isDrawing || !drawingRect || !startPoint) return;
      const p = canvas.getPointer(opt.e);
      const left = Math.min(p.x, startPoint.x);
      const top  = Math.min(p.y, startPoint.y);
      let w = Math.abs(p.x - startPoint.x);
      let h = Math.abs(p.y - startPoint.y);

      // magn√©tisme
      if (gridSize > 0) {
        const snap = (v) => Math.round(v / gridSize) * gridSize;
        w = Math.max(1, snap(w));
        h = Math.max(1, snap(h));
      }
      drawingRect.set({ left, top, width:w, height:h });
      canvas.requestRenderAll();
    });

    canvas.on('mouse:up', () => {
      canvas.defaultCursor = isPanMode ? 'grab' : 'default';
      canvas.isDragging = false;

      if (!isDrawing || !drawingRect) return;
      // une fois dessin√© ‚Üí on passe en move mode pour cette zone
      drawingRect.selectable = true;
      drawingRect = null;
      startPoint = null;
      save();
    });

    // Click s√©lection p√©dagogique
    canvas.on('mouse:up', (e) => {
      if (!isSelectMode) return;
      const target = e.target;
      if (!target || target === bgImgRef) return;

      // P√¢lir les autres zones
      canvas.getObjects().forEach(o => {
        if (o === bgImgRef) return;
        o.opacity = (o === target) ? 1 : 0.15;
      });
      canvas.requestRenderAll();

      // Remplir panneau depuis pieceId
      const pieceId =
        target.pieceId ??
        target.partId ??
        (target.data && (target.data.pieceId || target.data.partId)) ??
        target.customPieceId;

      if (pieceId != null && INVENTAIRE_QUINCY_310L.length) {
        const p = INVENTAIRE_QUINCY_310L.find(x => String(x.id) === String(pieceId));
        if (p) {
          const t = document.getElementById('partTitle');
          const d = document.getElementById('partDescription');
          const s = document.getElementById('inventorySelect');
          if (t) t.value = p.nom || p.name || '';
          if (d) d.value = p.desc || p.description || '';
          if (s) s.value = p.id;
        }
      } else {
        // sinon, mettre les donn√©es d√©j√† stock√©es
        document.getElementById('partTitle').value = target.title || '';
        document.getElementById('partDescription').value = target.desc || '';
      }
    });

    // Pinch-zoom mobile
    let lastDistance = 0;
    canvas.upperCanvasEl.addEventListener('touchstart', (e) => {
      if (e.touches.length === 2) lastDistance = getTouchDist(e);
    }, {passive:false});
    canvas.upperCanvasEl.addEventListener('touchmove', (e) => {
      if (e.touches.length === 2) {
        e.preventDefault();
        const d = getTouchDist(e);
        if (lastDistance) {
          const delta = d - lastDistance;
          const factor = 1 + (delta / 300);
          const newZoom = clamp(canvas.getZoom() * factor, 0.25, 3);
          canvas.zoomToPoint({ x: e.touches[0].clientX, y: e.touches[0].clientY }, newZoom);
          document.getElementById('zoom').value = Math.round(newZoom * 100);
        }
        lastDistance = d;
      }
    }, {passive:false});
    function getTouchDist(e){ const [a,b] = e.touches; const dx=a.clientX-b.clientX, dy=a.clientY-b.clientY; return Math.hypot(dx,dy); }

    // Molette zoom desktop
    canvas.on('mouse:wheel', (opt) => {
      const delta = -opt.e.deltaY;
      const zoom = clamp(canvas.getZoom() * (1 + delta/1000), 0.25, 3);
      canvas.zoomToPoint({ x: opt.e.offsetX, y: opt.e.offsetY }, zoom);
      document.getElementById('zoom').value = Math.round(zoom*100);
      opt.e.preventDefault();
      opt.e.stopPropagation();
    });

    // ================== UI HOOKS ==================
    document.getElementById('btn-draw').addEventListener('click', () => {
      setMode({draw:true});
      setActiveButton('btn-draw');
    });

    document.getElementById('btn-move').addEventListener('click', () => {
      setMode({move:true});
      setActiveButton('btn-move');
    });

    document.getElementById('btn-pan').addEventListener('click', () => {
      setMode({pan:true});
      setActiveButton('btn-pan');
    });

    document.getElementById('btn-select').addEventListener('click', () => {
      setMode({select:true});
      setActiveButton('btn-select');
    });

    document.getElementById('btn-delete').addEventListener('click', () => {
      const o = canvas.getActiveObject();
      if (o && o !== bgImgRef) { canvas.remove(o); save(); }
    });

    document.getElementById('btn-clear').addEventListener('click', () => {
      if (!confirm('Effacer toutes les zones ?')) return;
      canvas.getObjects().slice().forEach(o => { if (o !== bgImgRef) canvas.remove(o); });
      save();
    });

    document.getElementById('zoom').addEventListener('input', (e) => {
      const z = clamp(Number(e.target.value)/100, 0.25, 3);
      canvas.setZoom(z);
      canvas.requestRenderAll();
    });

    document.getElementById('gridSlider').addEventListener('input', (e) => {
      gridSize = Number(e.target.value)||0;
      document.getElementById('gridVal').textContent = gridSize;
    });

    document.getElementById('toggle-fit').addEventListener('click', () => {
      FIT_MODE = (FIT_MODE === 'contain') ? 'cover' : 'contain';
      refreshToggleLabel();
      if (bgImgRef) fitBackgroundImage(bgImgRef);
      save();
    });

    document.getElementById('btn-fit').addEventListener('click', () => {
      if (bgImgRef) fitBackgroundImage(bgImgRef);
      canvas.requestRenderAll();
    });

    document.getElementById('btn-export').addEventListener('click', exportJSON);

    document.getElementById('fileImport').addEventListener('change', (e) => {
      const f = e.target.files[0];
      importJSON(f);
      e.target.value = '';
    });

    document.getElementById('btn-screenshot').addEventListener('click', () => {
      canvas.discardActiveObject();
      canvas.requestRenderAll();
      const url = canvas.toDataURL({format:'png', quality:1});
      const a = document.createElement('a');
      a.href = url; a.download = 'quincy_310L.png';
      a.click();
    });

    document.getElementById('btn-apply').addEventListener('click', () => {
      const o = canvas.getActiveObject();
      if (!o || o === bgImgRef) { alert('S√©lectionne une zone.'); return; }
      applyPanelTo(o);
    });

    document.getElementById('btn-center').addEventListener('click', () => {
      const o = canvas.getActiveObject();
      if (!o || o === bgImgRef) return;
      canvas.setViewportTransform([1,0,0,1,0,0]); // reset pan/zoom
      canvas.centerObject(o);
      canvas.setActiveObject(o);
      canvas.requestRenderAll();
    });

    document.getElementById('btn-show-all').addEventListener('click', () => {
      canvas.getObjects().forEach(o => { if (o !== bgImgRef) o.opacity = 1; });
      canvas.requestRenderAll();
    });

    // Cacher le bouton "Arr√™ter le serveur" en ligne, l‚Äôafficher en local
    (function(){
      const b = document.getElementById('btn-stop-server');
      const isLocal = ['localhost','127.0.0.1'].includes(location.hostname);
      if (isLocal) b.classList.remove('hidden'); else b.classList.add('hidden');
    })();

    // ================== BOOT ==================
    resizeCanvasToStage();
    loadBackground();
    loadInventory();
    setMode({draw:false, move:true});  // par d√©faut : d√©placer/redim
    setActiveButton('btn-move');

    // Sauvegarde p√©riodique (secours)
    setInterval(save, 5000);
  </script>
</body>
</html>




